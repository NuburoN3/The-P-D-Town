<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">
<title>Dojo Town</title>
<style>
body {
  margin:0;
  background:#0f1720;
  overflow:hidden;
}

canvas{
display:block;
margin:auto;
image-rendering: pixelated;
background:#a7d9a8;
} </style>

</head>
<body>

<canvas id="game" width="640" height="480"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const TILE = 32;
const MAP_W = 30;
const MAP_H = 30;

/* ========= INPUT ========= */

const keys = {};
addEventListener("keydown", e=>keys[e.key.toLowerCase()]=true);
addEventListener("keyup", e=>keys[e.key.toLowerCase()]=false);
let interactPressed = false;

addEventListener("keydown", e=>{
  if(e.key === "Enter") interactPressed = true;
});


/* ========= PLAYER ========= */

const player = {
  x: 15*TILE,
  y: 18*TILE,
  speed: 2.2,
  dir: "down",
  walking:false,
  frame:0,

)
/* ========= INTERACTION ========= */

if(interactPressed){

  let tx = Math.floor(player.x / TILE);
  let ty = Math.floor(player.y / TILE);

  if(player.dir==="up") ty--;
  if(player.dir==="down") ty++;
  if(player.dir==="left") tx--;
  if(player.dir==="right") tx++;

  if(map[ty] && map[ty][tx]===4){
    showMessage("The Dojo");
  }

  interactPressed=false;
}

/* walking away closes message */
if(messageTimer>0){
  const px = Math.floor(player.x/TILE);
  const py = Math.floor(player.y/TILE);
  if(Math.abs(px-15)>2 || Math.abs(py-15)>2){
    messageTimer=0;
  }
}
}



/* ========= CAMERA ========= */

function camera(){
  return {
    x: player.x-canvas.width/2,
    y: player.y-canvas.height/2
  };
}

/* ========= DRAW TILES ========= */

function drawTile(type,x,y){
  if(type===0){
    ctx.fillStyle="#7ecf7e";
    ctx.fillRect(x,y,TILE,TILE);
  }

  if(type===1){
    ctx.fillStyle="#d8c89a";
    ctx.fillRect(x,y,TILE,TILE);
  }

  if(type===2){
    ctx.fillStyle="#2e7d32";
    ctx.fillRect(x,y,TILE,TILE);
    ctx.fillStyle="#1b5e20";
    ctx.fillRect(x+8,y+8,16,16);
  }

  if(type===3){
    ctx.fillStyle="#8d6e63";
    ctx.fillRect(x,y,TILE,TILE);
  }
if(type===4){
  // post
  ctx.fillStyle="#6d4c41";
  ctx.fillRect(x+12,y+8,8,18);

  // sign board
  ctx.fillStyle="#d7ccc8";
  ctx.fillRect(x+6,y+6,20,10);
}

}

/* ========= DRAW PLAYER ========= */

function drawPlayer(cam){
  const px=player.x-cam.x;
  const py=player.y-cam.y;

  ctx.fillStyle="#2b2b2b";
  ctx.fillRect(px+6,py+8,20,20);

  ctx.fillStyle="#ffffff";
  ctx.fillRect(px+10,py+4,12,8);

  if(player.walking && player.frame===0){
    ctx.fillRect(px+8,py+26,6,6);
  }else{
    ctx.fillRect(px+18,py+26,6,6);
  }
}

/* ========= DIALOG SYSTEM ========= */

let message = "";
let messageTimer = 0;

function showMessage(text){
  message = text;
  messageTimer = 180; // 3 seconds (60fps)
}

function drawTextbox(){
  if(messageTimer <= 0) return;

  const boxHeight = 90;

  ctx.fillStyle="rgba(0,0,0,0.75)";
  ctx.fillRect(20, canvas.height - boxHeight - 20, canvas.width-40, boxHeight);

  ctx.strokeStyle="#ffffff";
  ctx.lineWidth=3;
  ctx.strokeRect(20, canvas.height - boxHeight - 20, canvas.width-40, boxHeight);

  ctx.fillStyle="#ffffff";
  ctx.font="20px monospace";
  ctx.fillText(message, 40, canvas.height - 60);

  messageTimer--;
}

/* ========= RENDER ========= */

function render(){
  const cam=camera();
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let y=0;y<MAP_H;y++){
    for(let x=0;x<MAP_W;x++){
      const drawX=x*TILE-cam.x;
      const drawY=y*TILE-cam.y;

      if(drawX>-TILE&&drawY>-TILE&&drawX<canvas.width&&drawY<canvas.height){
        drawTile(map[y][x],drawX,drawY);
      }
    }
  }

  drawPlayer(cam);
drawTextbox();

}

/* ========= LOOP ========= */

function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

loop();
</script>

</body>
</html>

